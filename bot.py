import asyncio
import logging
import os
from flask import Flask, request
from apscheduler.schedulers.background import BackgroundScheduler
from telegram import Update
from telegram.ext import Application, CommandHandler, ContextTypes

# ================== CONFIG ==================
BOT_TOKEN = "8040860578:AAHKb0r7J7FBdu5OqA0tg-XbvsLR0MGQ4b4"
WEBHOOK_URL = "https://hosin-q20k.onrender.com/webhook"  # ุบูุฑูุง ูู ุบูุฑุช ุงุณู ุงููุดุฑูุน
OWNER_ID = 7635779264
# ===========================================

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
active_chats = set()

# ุฃุฐูุงุฑ ุงูุตุจุงุญ ูุงููุฉ ููุฑุชุจุฉ (ููุง ูู)
MORNING_DUA = """๐ *ุฃุฐูุงุฑ ุงูุตุจุงุญ* ๐

ุฃูุนููุฐู ุจูุงูููููู ูููู ุงูุดููููุทูุงูู ุงูุฑููุฌูููู

๏ดฟ ุงูููููู ููุง ุฅููููฐูู ุฅููููุง ูููู ุงููุญูููู ุงูููููููููู  ููุง ุชูุฃูุฎูุฐููู ุณูููุฉู ููููุง ูููููู  ูููู ููุง ููู ุงูุณููููุงููุงุชู ููููุง ููู ุงููุฃูุฑูุถู  ูููู ุฐูุง ุงูููุฐูู ููุดูููุนู ุนูููุฏููู ุฅููููุง ุจูุฅูุฐููููู  ููุนููููู ููุง ุจููููู ุฃูููุฏูููููู ููููุง ุฎููููููููู  ููููุง ููุญููุทูููู ุจูุดูููุกู ูููู ุนููููููู ุฅููููุง ุจูููุง ุดูุงุกู  ููุณูุนู ููุฑูุณูููููู ุงูุณููููุงููุงุชู ููุงููุฃูุฑูุถู  ููููุง ููุฆููุฏููู ุญูููุธูููููุง  ูููููู ุงููุนูููููู ุงููุนูุธูููู ๏ดพ
(ูฃ ูุฑุงุช)

๏ดฟ ูููู ูููู ุงูููููู ุฃูุญูุฏู  ุงูููููู ุงูุตููููุฏู  ูููู ููููุฏู ูููููู ูููููุฏู  ูููููู ูููููู ูููู ููููููุง ุฃูุญูุฏู ๏ดพ
(ูฃ ูุฑุงุช)

๏ดฟ ูููู ุฃูุนููุฐู ุจูุฑูุจูู ุงูููููููู  ูููู ุดูุฑูู ููุง ุฎููููู  ูููููู ุดูุฑูู ุบูุงุณููู ุฅูุฐูุง ููููุจู  ูููููู ุดูุฑูู ุงูููููููุงุซูุงุชู ููู ุงููุนูููุฏู  ูููููู ุดูุฑูู ุญูุงุณูุฏู ุฅูุฐูุง ุญูุณูุฏู ๏ดพ
(ูฃ ูุฑุงุช)

๏ดฟ ูููู ุฃูุนููุฐู ุจูุฑูุจูู ุงููููุงุณู  ูููููู ุงููููุงุณู  ุฅููููฐูู ุงููููุงุณู  ูููู ุดูุฑูู ุงููููุณูููุงุณู ุงููุฎููููุงุณู  ุงูููุฐูู ููููุณูููุณู ููู ุตูุฏููุฑู ุงููููุงุณู  ูููู ุงููุฌููููุฉู ููุงููููุงุณู ๏ดพ
(ูฃ ูุฑุงุช)

ุฃูุตูุจูุญูููุง ููุฃูุตูุจูุญู ุงูููููููู ููููููู ููุงููุญูููุฏู ูููููููุ ููุง ุฅููููู ุฅููููุง ุงูููููู ููุญูุฏููู ููุง ุดูุฑูููู ููููุ ูููู ุงูููููููู ูููููู ุงููุญูููุฏู ูููููู ุนูููู ููููู ุดูููุกู ููุฏููุฑูุ ุฑูุจูู ุฃูุณูุฃููููู ุฎูููุฑู ููุง ููู ููุฐูุง ุงูููููููู ููุฎูููุฑู ููุง ุจูุนูุฏูููุ ููุฃูุนููุฐู ุจููู ูููู ุดูุฑูู ููุง ููู ููุฐูุง ุงูููููููู ููุดูุฑูู ููุง ุจูุนูุฏูููุ ุฑูุจูู ุฃูุนููุฐู ุจููู ูููู ุงููููุณููู ููุณููุกู ุงููููุจูุฑูุ ุฑูุจูู ุฃูุนููุฐู ุจููู ูููู ุนูุฐูุงุจู ููู ุงููููุงุฑู ููุนูุฐูุงุจู ููู ุงููููุจูุฑู

ุฑูุถููุชู ุจูุงูููููู ุฑูุจููุง ููุจูุงููุฅูุณูููุงูู ุฏููููุง ููุจูููุญููููุฏู ุตููููู ุงูููููู ุนููููููู ููุณูููููู ููุจููููุง (ูฃ ูุฑุงุช)

ุณูุจูุญูุงูู ุงูููููู ููุจูุญูููุฏููู ุนูุฏูุฏู ุฎููููููู ููุฑูุถูุง ููููุณููู ููุฒูููุฉู ุนูุฑูุดููู ููููุฏูุงุฏู ููููููุงุชููู (ูฃ ูุฑุงุช)

ุญูุณูุจููู ุงูููููู ููุง ุฅููููฐูู ุฅููููุง ูููู ุนููููููู ุชููููููููุชู ูููููู ุฑูุจูู ุงููุนูุฑูุดู ุงููุนูุธูููู (ูง ูุฑุงุช)"""

# ุฃุฐูุงุฑ ุงููุณุงุก ูุงููุฉ (ููุง ูู)
EVENING_DUA = """๐ *ุฃุฐูุงุฑ ุงููุณุงุก* ๐

ุฃูุนููุฐู ุจูุงูููููู ูููู ุงูุดููููุทูุงูู ุงูุฑููุฌูููู

ุขูุฉ ุงููุฑุณู (ูุฑุฉ ูุงุญุฏุฉ)

ุงููุนูุฐุงุช ุงูุซูุงุซ (ูฃ ูุฑุงุช)

ุฃูููุณูููููุง ููุฃูููุณูู ุงูููููููู ููููููู ููุงููุญูููุฏู ูููููููุ ููุง ุฅููููู ุฅููููุง ุงูููููู ููุญูุฏููู ููุง ุดูุฑูููู ููููุ ูููู ุงูููููููู ูููููู ุงููุญูููุฏู ูููููู ุนูููู ููููู ุดูููุกู ููุฏููุฑูุ ุฑูุจูู ุฃูุณูุฃููููู ุฎูููุฑู ููุง ููู ููุฐููู ุงููููููููุฉู ููุฎูููุฑู ููุง ุจูุนูุฏูููุงุ ููุฃูุนููุฐู ุจููู ูููู ุดูุฑูู ููุง ููู ููุฐููู ุงููููููููุฉู ููุดูุฑูู ููุง ุจูุนูุฏูููุงุ ุฑูุจูู ุฃูุนููุฐู ุจููู ูููู ุงููููุณููู ููุณููุกู ุงููููุจูุฑูุ ุฑูุจูู ุฃูุนููุฐู ุจููู ูููู ุนูุฐูุงุจู ููู ุงููููุงุฑู ููุนูุฐูุงุจู ููู ุงููููุจูุฑู

ุฑูุถููุชู ุจูุงูููููู ุฑูุจููุง ููุจูุงููุฅูุณูููุงูู ุฏููููุง ููุจูููุญููููุฏู ููุจููููุง (ูฃ ูุฑุงุช)

ุณูุจูุญูุงูู ุงูููููู ููุจูุญูููุฏููู ุนูุฏูุฏู ุฎููููููู... (ูฃ ูุฑุงุช)

ุญูุณูุจููู ุงูููููู ููุง ุฅููููฐูู ุฅููููุง ูููู ุนููููููู ุชููููููููุชู ูููููู ุฑูุจูู ุงููุนูุฑูุดู ุงููุนูุธูููู (ูง ูุฑุงุช)

ุจูุงุณููููู ุงููููููููู ุฃููููุชู ููุฃูุญูููุง"""

app = Flask(__name__)
application = Application.builder().token(BOT_TOKEN).build()
scheduler = BackgroundScheduler()

# Event loop ุซุงุจุช ูุชุฌูุจ ุฃุฎ Heritage loop closed
loop = asyncio.get_event_loop()

# ุฏุงูุฉ start ูุน ุงูุฑุณุงูุฉ ุงููู ุทูุจุชูุง ุจุงูุถุจุท
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat = update.effective_chat
    user = update.effective_user

    if chat.type == "private":
        active_chats.add(chat.id)
    elif chat.type in ("group", "supergroup"):
        if user.id != OWNER_ID:
            return  # ููุท ุงูุฃููุฑ ููุฏุฑ ูุถูู ุงูุฌุฑูุจ
        active_chats.add(chat.id)

    await update.message.reply_text(
        "๐ค ุจูุช ุฃุฐูุงุฑ ุงูุตุจุงุญ ูุงููุณุงุก\n\n"
        "๐คฒ ูุง ุชูุณูุง ุงูุฏุนุงุก ููู ูุงู ุณุจุจุงู ูู ูุฐุง ุงูุฎูุฑ: @mohamedelhocine\n"
        "๐๏ธ ุงูุตุงูุน: @Mik_emm"
    )

async def broadcast(text):
    failed = []
    for chat_id in list(active_chats):
        try:
            await application.bot.send_message(
                chat_id=chat_id,
                text=text,
                parse_mode="Markdown",
                disable_web_page_preview=True
            )
            await asyncio.sleep(0.33)  # ุถุฏ ุงูุญุธุฑ
        except Exception as e:
            logging.warning(f"ูุดู ุฅุฑุณุงู ุฅูู {chat_id}: {e}")
            failed.append(chat_id)
    for f in failed:
        active_chats.discard(f)

async def send_morning():
    await broadcast(MORNING_DUA)

async def send_evening():
    await broadcast(EVENING_DUA)

def heartbeat():
    logging.info("โค๏ธ Heartbeat: ุงูุจูุช ุดุบุงู ุชูุงู")

@app.route("/webhook", methods=["POST"])
def webhook():
    json_data = request.get_json(force=True)
    update = Update.de_json(json_data, application.bot)
    asyncio.run_coroutine_threadsafe(application.process_update(update), loop)
    return "OK", 200

def schedule_jobs():
    scheduler.add_job(lambda: loop.create_task(send_morning()), "cron", hour=8, minute=30, timezone="Africa/Cairo")
    scheduler.add_job(lambda: loop.create_task(send_evening()), "cron", hour=16, minute=0, timezone="Africa/Cairo")
    scheduler.add_job(heartbeat, "interval", minutes=10)
    scheduler.start()

if __name__ == "__main__":
    application.add_handler(CommandHandler("start", start))

    # ุชุดุบูู ูู ุญุงุฌุฉ ูู ุงูู loop ุงูุซุงุจุช
    loop.run_until_complete(application.initialize())
    loop.run_until_complete(application.start())
    loop.run_until_complete(application.bot.set_webhook(url=WEBHOOK_URL))
    logging.info("โ Webhook ุชู ุชุนูููู ุจูุฌุงุญ")

    # ุฌุฏููุฉ ุงูุฅุฑุณุงู
    schedule_jobs()

    # ุชุดุบูู Flask
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port)
