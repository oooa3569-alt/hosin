import os
import logging
import asyncio
import threading
from datetime import datetime, time
import pytz
from flask import Flask, request, jsonify
from telegram import Bot, Update
from telegram.ext import Application, CommandHandler, ContextTypes

# ========== ุฅุนุฏุงุฏุงุช ุงูุจูุช ==========
TELEGRAM_TOKEN = "8260168982:AAEy-YQDWa-yTqJKmsA_yeSuNtZb8qNeHAI"
ADMIN_ID = 7635779264
GROUP_ID = "-1002225164483"

# ========== ุงูุชูููุชุงุช (ุชูููุช ุงูุฑูุงุถ) ==========
TIMEZONE = pytz.timezone('Asia/Riyadh')
MORNING_TIME = time(8, 30)    # 8:30 ุตุจุงุญุงู
NOON_DHIKR_TIME = time(12, 0)  # 12:00 ุธูุฑุงู
EVENING_TIME = time(16, 0)    # 4:00 ูุณุงุกู
EVENING_DHIKR2_TIME = time(18, 0)  # 6:00 ูุณุงุกู
NIGHT_TIME = time(23, 0)      # 11:00 ูุณุงุกู

# ========== ุงูุฃุฐูุงุฑ ุงููุงููุฉ ==========

MORNING_DHIKR = """๐ *ุฃุฐูุงุฑ ุงูุตุจุงุญ*

*ุฃุนูุฐ ุจูููุงุช ุงููู ุงูุชุงูุงุช ูู ุดุฑ ูุง ุฎูู* (ูฃ ูุฑุงุช)

*ุงูููู ุตู ูุณูู ุนูู ูุจููุง ูุญูุฏ* (ูค ูุฑุงุช)

*ุงูููู ุฃูุช ุฑุจู ูุง ุฅูู ุฅูุง ุฃูุชุ ุฎููุชูู ูุฃูุง ุนุจุฏูุ ูุฃูุง ุนูู ุนูุฏู ููุนุฏู ูุง ุงุณุชุทุนุชุ ุฃุนูุฐ ุจู ูู ุดุฑ ูุง ุตูุนุชุ ุฃุจูุก ูู ุจูุนูุชู ุนูู ูุฃุจูุก ุจุฐูุจู ูุงุบูุฑ ูู ูุฅูู ูุง ูุบูุฑ ุงูุฐููุจ ุฅูุง ุฃูุช*

*ุจุณู ุงููู ุงูุฐู ูุง ูุถุฑ ูุน ุงุณูู ุดูุก ูู ุงูุฃุฑุถ ููุง ูู ุงูุณูุงุก ููู ุงูุณููุน ุงูุนููู* (ูฃ ูุฑุงุช)

*ุฑุถูุช ุจุงููู ุฑุจุง ูุจุงูุฅุณูุงู ุฏููุง ูุจูุญูุฏ ุตูู ุงููู ุนููู ูุณูู ูุจูุง* (ูฃ ูุฑุงุช)

*ุงูููู ุตู ูุณูู ูุจุงุฑู ุนูู ูุจููุง ูุญูุฏ* (ูข ูุฑุงุช)

*ุฃุตุจุญูุง ูุฃุตุจุญ ุงูููู ููู ูุงูุญูุฏ ูููุ ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏุ ููู ุนูู ูู ุดูุก ูุฏูุฑุ ุฑุจ ุฃุณุฃูู ุฎูุฑ ูุง ูู ูุฐุง ุงูููู ูุฎูุฑ ูุง ุจุนุฏูุ ูุฃุนูุฐ ุจู ูู ุดุฑ ูุง ูู ูุฐุง ุงูููู ูุดุฑ ูุง ุจุนุฏูุ ุฑุจ ุฃุนูุฐ ุจู ูู ุงููุณู ูุณูุก ุงููุจุฑุ ุฑุจ ุฃุนูุฐ ุจู ูู ุนุฐุงุจ ูู ุงููุงุฑ ูุนุฐุงุจ ูู ุงููุจุฑ*

*ุงูููู ูุง ุฃุตุจุญ ุจู ูู ูุนูุฉ ุฃู ุจุฃุญุฏ ูู ุฎููู ูููู ูุญุฏู ูุง ุดุฑูู ููุ ููู ุงูุญูุฏ ููู ุงูุดูุฑ*

*ุงูููู ุนุงูู ุงูุบูุจ ูุงูุดูุงุฏุฉ ูุงุทุฑ ุงูุณูุงูุงุช ูุงูุฃุฑุถ ุฑุจ ูู ุดูุก ููููููุ ุฃุดูุฏ ุฃู ูุง ุฅูู ุฅูุง ุฃูุชุ ุฃุนูุฐ ุจู ูู ุดุฑ ููุณู ููู ุดุฑ ุงูุดูุทุงู ูุดุฑููุ ูุฃู ุฃูุชุฑู ุนูู ููุณู ุณูุกุง ุฃู ุฃุฌุฑู ุฅูู ูุณูู*

*ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏุ ููู ุนูู ูู ุดูุก ูุฏูุฑ*

๐๏ธ *ุงูุตุงูุน:* @Mik_emm
๐ก *ููุฑุฉ:* @mohamedelhocine"""

EVENING_DHIKR = """๐ *ุฃุฐูุงุฑ ุงููุณุงุก*

*ุฃุนูุฐ ุจูููุงุช ุงููู ุงูุชุงูุงุช ูู ุดุฑ ูุง ุฎูู* (ูฃ ูุฑุงุช)

*ุงูููู ุตู ูุณูู ุนูู ูุจููุง ูุญูุฏ* (ูค ูุฑุงุช)

*ุงูููู ุฃูุช ุฑุจู ูุง ุฅูู ุฅูุง ุฃูุชุ ุฎููุชูู ูุฃูุง ุนุจุฏูุ ูุฃูุง ุนูู ุนูุฏู ููุนุฏู ูุง ุงุณุชุทุนุชุ ุฃุนูุฐ ุจู ูู ุดุฑ ูุง ุตูุนุชุ ุฃุจูุก ูู ุจูุนูุชู ุนูู ูุฃุจูุก ุจุฐูุจู ูุงุบูุฑ ูู ูุฅูู ูุง ูุบูุฑ ุงูุฐููุจ ุฅูุง ุฃูุช*

*ุจุณู ุงููู ุงูุฐู ูุง ูุถุฑ ูุน ุงุณูู ุดูุก ูู ุงูุฃุฑุถ ููุง ูู ุงูุณูุงุก ููู ุงูุณููุน ุงูุนููู* (ูฃ ูุฑุงุช)

*ุฑุถูุช ุจุงููู ุฑุจุง ูุจุงูุฅุณูุงู ุฏููุง ูุจูุญูุฏ ุตูู ุงููู ุนููู ูุณูู ูุจูุง* (ูฃ ูุฑุงุช)

*ุงูููู ุตู ูุณูู ูุจุงุฑู ุนูู ูุจููุง ูุญูุฏ* (ูข ูุฑุงุช)

*ุฃูุณููุง ูุฃูุณู ุงูููู ููู ูุงูุญูุฏ ูููุ ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏุ ููู ุนูู ูู ุดูุก ูุฏูุฑุ ุฑุจ ุฃุณุฃูู ุฎูุฑ ูุง ูู ูุฐู ุงููููุฉ ูุฎูุฑ ูุง ุจุนุฏูุงุ ูุฃุนูุฐ ุจู ูู ุดุฑ ูุง ูู ูุฐู ุงููููุฉ ูุดุฑ ูุง ุจุนุฏูุงุ ุฑุจ ุฃุนูุฐ ุจู ูู ุงููุณู ูุณูุก ุงููุจุฑุ ุฑุจ ุฃุนูุฐ ุจู ูู ุนุฐุงุจ ูู ุงููุงุฑ ูุนุฐุงุจ ูู ุงููุจุฑ*

*ุงูููู ูุง ุฃูุณู ุจู ูู ูุนูุฉ ุฃู ุจุฃุญุฏ ูู ุฎููู ูููู ูุญุฏู ูุง ุดุฑูู ููุ ููู ุงูุญูุฏ ููู ุงูุดูุฑ*

*ุงูููู ุนุงูู ุงูุบูุจ ูุงูุดูุงุฏุฉ ูุงุทุฑ ุงูุณูุงูุงุช ูุงูุฃุฑุถ ุฑุจ ูู ุดูุก ููููููุ ุฃุดูุฏ ุฃู ูุง ุฅูู ุฅูุง ุฃูุชุ ุฃุนูุฐ ุจู ูู ุดุฑ ููุณู ููู ุดุฑ ุงูุดูุทุงู ูุดุฑููุ ูุฃู ุฃูุชุฑู ุนูู ููุณู ุณูุกุง ุฃู ุฃุฌุฑู ุฅูู ูุณูู*

*ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏุ ููู ุนูู ูู ุดูุก ูุฏูุฑ*

๐๏ธ *ุงูุตุงูุน:* @Mik_emm
๐ก *ููุฑุฉ:* @mohamedelhocine"""

SLEEP_DHIKR = """๐ *ูุงู ูุฃูุช ูุบููุฑ ุงูุฐูุจ*

ูุงู ุฑุณูู ุงููู ๏ทบ:
*"ูู ูุงู ุญูู ูุฃูู ุฅูู ูุฑุงุดู:*
'ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏุ ููู ุนูู ูู ุดูุก ูุฏูุฑุ ูุง ุญูู ููุง ููุฉ ุฅูุง ุจุงูููุ ุณุจุญุงู ุงููู ูุงูุญูุฏ ููู ููุง ุฅูู ุฅูุง ุงููู ูุงููู ุฃูุจุฑ'

*ุบูุฑ ุงููู ุฐููุจู ุฃู ุฎุทุงูุงู ูุฅู ูุงูุช ูุซู ุฒุจุฏ ุงูุจุญุฑ."* ๐ค๐

๐๏ธ *ุงูุตุงูุน:* @Mik_emm
๐ก *ููุฑุฉ:* @mohamedelhocine"""

REMEMBER_DHIKR = """๐ฟ *ูุงุฐูุฑ ุฑุจู ุฅุฐุง ูุณูุช*

ุณูุจุญุงู ุงููู
ุงูุญูุฏููู  
ุงููู ุฃูุจุฑ
ุฃุณุชุบูุฑ ุงููู
ูุง ุฅูู ุฅูุง ุงููู
ูุงุญูู ููุง ููุฉ ุฅูุง ุจุงููู
ุณูุจุญุงู ุงููู ูุจุญูุฏู
ุณูุจุญุงู ุงููู ุงูุนุธูู
ุงููููููููู ุตููู ูุณููู ุนูู ูุจููุง ูุญูุฏ
ูุง ุฅูู ุฅูุง ุฃูุช ุณูุจุญุงูู ุฅูู ููุช ูู ุงูุธุงูููู

๐๏ธ *ุงูุตุงูุน:* @Mik_emm
๐ก *ููุฑุฉ:* @mohamedelhocine"""

# ========== ุฅูุดุงุก ุงูุชุทุจูู ==========
app = Flask(__name__)
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ========== ูุชุบูุฑุงุช ุนุงูุฉ ==========
bot = None
scheduler_thread = None
is_running = False

# ========== ูุธุงุฆู ุงููุณุงุนุฏุฉ ==========
async def send_dhikr(chat_id, text):
    """ุฅุฑุณุงู ุฐูุฑ ุฅูู ุงููุฌููุนุฉ"""
    try:
        await bot.send_message(
            chat_id=chat_id,
            text=text,
            parse_mode='Markdown'
        )
        logger.info(f"โ ุชู ุฅุฑุณุงู ุฐูุฑ ุฅูู ุงููุฌููุนุฉ {chat_id}")
        return True
    except Exception as e:
        logger.error(f"โ ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุฐูุฑ: {e}")
        return False

async def send_to_admin(message):
    """ุฅุฑุณุงู ุฑุณุงูุฉ ููุฃุฏูู"""
    try:
        await bot.send_message(
            chat_id=ADMIN_ID,
            text=message,
            parse_mode='Markdown'
        )
    except Exception as e:
        logger.error(f"โ ุฎุทุฃ ูู ุฅุฑุณุงู ุฑุณุงูุฉ ููุฃุฏูู: {e}")

async def check_and_send_dhikr():
    """ูุญุต ุงูููุช ูุฅุฑุณุงู ุงูุฃุฐูุงุฑ"""
    global is_running
    
    while is_running:
        try:
            now = datetime.now(TIMEZONE)
            current_time = now.time()
            
            # ุฃุฐูุงุฑ ุงูุตุจุงุญ 8:30
            if current_time.hour == MORNING_TIME.hour and current_time.minute == MORNING_TIME.minute:
                await send_dhikr(GROUP_ID, MORNING_DHIKR)
                await send_to_admin("โ ุชู ุฅุฑุณุงู ุฃุฐูุงุฑ ุงูุตุจุงุญ")
            
            # ุฐูุฑ "ูุงุฐูุฑ ุฑุจู" 12:00
            elif current_time.hour == NOON_DHIKR_TIME.hour and current_time.minute == NOON_DHIKR_TIME.minute:
                await send_dhikr(GROUP_ID, REMEMBER_DHIKR)
                await send_to_admin("โ ุชู ุฅุฑุณุงู ุฐูุฑ 'ูุงุฐูุฑ ุฑุจู' (ุงูุธูุฑ)")
            
            # ุฃุฐูุงุฑ ุงููุณุงุก 4:00
            elif current_time.hour == EVENING_TIME.hour and current_time.minute == EVENING_TIME.minute:
                await send_dhikr(GROUP_ID, EVENING_DHIKR)
                await send_to_admin("โ ุชู ุฅุฑุณุงู ุฃุฐูุงุฑ ุงููุณุงุก")
            
            # ุฐูุฑ "ูุงุฐูุฑ ุฑุจู" 6:00
            elif current_time.hour == EVENING_DHIKR2_TIME.hour and current_time.minute == EVENING_DHIKR2_TIME.minute:
                await send_dhikr(GROUP_ID, REMEMBER_DHIKR)
                await send_to_admin("โ ุชู ุฅุฑุณุงู ุฐูุฑ 'ูุงุฐูุฑ ุฑุจู' (ุงููุณุงุก)")
            
            # ุฐูุฑ ุงูููู 11:00
            elif current_time.hour == NIGHT_TIME.hour and current_time.minute == NIGHT_TIME.minute:
                await send_dhikr(GROUP_ID, SLEEP_DHIKR)
                await send_to_admin("โ ุชู ุฅุฑุณุงู ุฐูุฑ ุงูููู")
            
            # ุงูุชุธุฑ ุฏูููุฉ ูุจู ุงููุญุต ุงูุชุงูู
            await asyncio.sleep(60)
            
        except Exception as e:
            logger.error(f"โ ุฎุทุฃ ูู ุงูุฌุฏููุฉ: {e}")
            await asyncio.sleep(60)

def start_scheduler():
    """ุจุฏุก ุฌุฏููุฉ ุงูุฃุฐูุงุฑ ูู ุฎูุท ูููุตู"""
    global is_running
    
    if not is_running:
        is_running = True
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        loop.run_until_complete(check_and_send_dhikr())

# ========== ูุณุงุฑุงุช Flask ==========
@app.route('/')
def home():
    """ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ - ูุจุถ ุงูุญูุงุฉ"""
    return jsonify({
        "status": "online",
        "service": "Dhikr Bot",
        "admin": ADMIN_ID,
        "group": GROUP_ID,
        "creator": "@Mik_emm",
        "idea_owner": "@mohamedelhocine",
        "next_check": datetime.now(TIMEZONE).strftime("%Y-%m-%d %H:%M:%S")
    })

@app.route('/health')
def health_check():
    """ูุญุต ุตุญุฉ ุงูุจูุช"""
    return jsonify({
        "status": "healthy",
        "bot_running": is_running,
        "timestamp": datetime.now().isoformat()
    })

@app.route('/start_bot')
def start_bot_route():
    """ุจุฏุก ุงูุจูุช (ููุฃุฏูู ููุท)"""
    try:
        user_id = request.args.get('user_id', type=int)
        
        if user_id == ADMIN_ID:
            global bot, scheduler_thread
            
            # ุชููุฆุฉ ุงูุจูุช
            bot = Bot(token=TELEGRAM_TOKEN)
            
            # ุจุฏุก ุงูุฌุฏููุฉ ูู ุฎูุท ูููุตู
            if scheduler_thread is None or not scheduler_thread.is_alive():
                scheduler_thread = threading.Thread(target=start_scheduler, daemon=True)
                scheduler_thread.start()
                
                # ุฅุฑุณุงู ุฑุณุงูุฉ ุชุฃููุฏ
                asyncio.run(send_to_admin(
                    "๐ค *ุชู ุชุดุบูู ุจูุช ุงูุฃุฐูุงุฑ ุจูุฌุงุญ!*\n\n"
                    "โ ุชู ุชูุนูู ุงูุฅุดุนุงุฑุงุช ุงูููููุฉ\n"
                    "โฐ *ููุงุนูุฏ ุงูุฃุฐูุงุฑ:*\n"
                    "โข ุงูุตุจุงุญ: 8:30 ุตุจุงุญุงู\n"
                    "โข ูุงุฐูุฑ ุฑุจู: 12:00 ุธูุฑุงู\n"
                    "โข ุงููุณุงุก: 4:00 ูุณุงุกู\n"
                    "โข ูุงุฐูุฑ ุฑุจู: 6:00 ูุณุงุกู\n"
                    "โข ุงูููู: 11:00 ูุณุงุกู\n\n"
                    "๐คฒ ูุง ุชูุณูุง ุงูุฏุนุงุก ููู ูุงู ุณุจุจุงู ูู ูุฐุง ุงูุฎูุฑ\n"
                    "๐๏ธ ุงูุตุงูุน: @Mik_emm"
                ))
                
                return jsonify({
                    "success": True,
                    "message": "โ ุชู ุชุดุบูู ุงูุจูุช ุจูุฌุงุญ",
                    "schedule_started": True
                })
            else:
                return jsonify({
                    "success": False,
                    "message": "โ๏ธ ุงูุจูุช ูุนูู ุจุงููุนู"
                })
        else:
            return jsonify({
                "success": False,
                "message": "โ ุบูุฑ ูุตุฑุญ ูู ุจุชุดุบูู ุงูุจูุช"
            })
            
    except Exception as e:
        return jsonify({
            "success": False,
            "message": f"โ ุฎุทุฃ: {str(e)}"
        })

@app.route('/test_send')
def test_send():
    """ุงุฎุชุจุงุฑ ุฅุฑุณุงู ุฐูุฑ (ููุฃุฏูู ููุท)"""
    try:
        user_id = request.args.get('user_id', type=int)
        
        if user_id == ADMIN_ID:
            async def test():
                bot_test = Bot(token=TELEGRAM_TOKEN)
                await bot_test.send_message(
                    chat_id=ADMIN_ID,
                    text="โ *ุงุฎุชุจุงุฑ ุงูุจูุช*\n\nูุฐู ุฑุณุงูุฉ ุงุฎุชุจุงุฑูุฉ ูู ุจูุช ุงูุฃุฐูุงุฑ.\n\nุงูุญุงูุฉ: โ ูุนูู ุจูุฌุงุญ\n๐๏ธ ุงูุตุงูุน: @Mik_emm",
                    parse_mode='Markdown'
                )
            
            asyncio.run(test())
            return jsonify({"success": True, "message": "โ ุชู ุฅุฑุณุงู ุฑุณุงูุฉ ุงูุงุฎุชุจุงุฑ"})
        else:
            return jsonify({"success": False, "message": "โ ุบูุฑ ูุตุฑุญ"})
    except Exception as e:
        return jsonify({"success": False, "message": f"โ ุฎุทุฃ: {str(e)}"})

# ========== ุชุดุบูู ุงูุจูุช ุนูุฏ ุงูุจุฏุก ==========
def initialize_bot():
    """ุชููุฆุฉ ุงูุจูุช ุนูุฏ ุจุฏุก ุงูุชุดุบูู"""
    global bot
    try:
        bot = Bot(token=TELEGRAM_TOKEN)
        logger.info("โ ุชู ุชููุฆุฉ ุจูุช ุงูุชููุฌุฑุงู")
        
        # ุฅุฑุณุงู ุฑุณุงูุฉ ุจุฏุก ุงูุชุดุบูู ููุฃุฏูู
        async def send_startup_message():
            await send_to_admin(
                "๐ *ุจูุช ุงูุฃุฐูุงุฑ ูุนูู ุงูุขู*\n\n"
                "โ ุชู ุจุฏุก ุชุดุบูู ุงูุจูุช ุนูู ุงูุณูุฑูุฑ\n"
                "โฐ ุฌุงูุฒ ูุฅุฑุณุงู ุงูุฃุฐูุงุฑ ุชููุงุฆูุงู\n\n"
                "๐ *ููุงุนูุฏ ุงูุฃุฐูุงุฑ:*\n"
                "โข 8:30 ุตุจุงุญุงู - ุฃุฐูุงุฑ ุงูุตุจุงุญ\n"
                "โข 12:00 ุธูุฑุงู - ูุงุฐูุฑ ุฑุจู\n"
                "โข 4:00 ูุณุงุกู - ุฃุฐูุงุฑ ุงููุณุงุก\n"
                "โข 6:00 ูุณุงุกู - ูุงุฐูุฑ ุฑุจู\n"
                "โข 11:00 ูุณุงุกู - ุฐูุฑ ุงูููู\n\n"
                "๐ ุฑุงุจุท ุงูุจูุช: https://hosin-q20k.onrender.com\n"
                "๐๏ธ ุงูุตุงูุน: @Mik_emm\n"
                "๐ก ููุฑุฉ: @mohamedelhocine"
            )
        
        asyncio.run(send_startup_message())
        
        # ุจุฏุก ุงูุฌุฏููุฉ ุชููุงุฆูุงู
        global scheduler_thread
        scheduler_thread = threading.Thread(target=start_scheduler, daemon=True)
        scheduler_thread.start()
        logger.info("โ ุจุฏุก ุฌุฏููุฉ ุงูุฃุฐูุงุฑ ุชููุงุฆูุงู")
        
    except Exception as e:
        logger.error(f"โ ุฎุทุฃ ูู ุชููุฆุฉ ุงูุจูุช: {e}")

# ========== ุงูุชุดุบูู ุงูุฑุฆูุณู ==========
if __name__ == '__main__':
    # ุชููุฆุฉ ุงูุจูุช
    initialize_bot()
    
    # ุชุดุบูู ุฎุงุฏู Flask
    port = int(os.environ.get('PORT', 10000))
    app.run(host='0.0.0.0', port=port, debug=False)
