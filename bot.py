import os
import logging
import asyncio
import threading
import time
from datetime import datetime, time as dt_time
import pytz
from flask import Flask, request, jsonify
from telegram import Bot

# ================= asyncio loop ุซุงุจุช =================
event_loop = asyncio.new_event_loop()
asyncio.set_event_loop(event_loop)

def start_event_loop(loop):
    loop.run_forever()

threading.Thread(
    target=start_event_loop,
    args=(event_loop,),
    daemon=True
).start()

# ================= ุฅุนุฏุงุฏุงุช ุงูุจูุช =================
TELEGRAM_TOKEN = "8260168982:AAEy-YQDWa-yTqJKmsA_yeSuNtZb8qNeHAI"
ADMIN_ID = 7635779264
GROUPS = ["-1002225164483", "-1002576714713"]
WEBHOOK_URL = "https://hosin-q20k.onrender.com/webhook"

# ================= ุงูุชูููุช =================
TIMEZONE = pytz.timezone('Africa/Algiers')
MORNING_TIME = dt_time(8, 30)
EVENING_TIME = dt_time(16, 0)
NIGHT_TIME = dt_time(23, 0)

# ================= ุงูุฃุฐูุงุฑ =================
MORNING_DHIKR = """๐ ุฃุฐูุงุฑ ุงูุตุจุงุญ

ุฃุนูุฐ ุจูููุงุช ุงููู ุงูุชุงูุงุช ูู ุดุฑ ูุง ุฎูู (ูฃ ูุฑุงุช)

ุงูููู ุตู ูุณูู ุนูู ูุจููุง ูุญูุฏ (ูค ูุฑุงุช)

ุงูููู ุฃูุช ุฑุจู ูุง ุฅูู ุฅูุง ุฃูุชุ ุฎููุชูู ูุฃูุง ุนุจุฏูุ ูุฃูุง ุนูู ุนูุฏู ููุนุฏู ูุง ุงุณุชุทุนุชุ ุฃุนูุฐ ุจู ูู ุดุฑ ูุง ุตูุนุชุ ุฃุจูุก ูู ุจูุนูุชู ุนูู ูุฃุจูุก ุจุฐูุจู ูุงุบูุฑ ูู ูุฅูู ูุง ูุบูุฑ ุงูุฐููุจ ุฅูุง ุฃูุช

ุจุณู ุงููู ุงูุฐู ูุง ูุถุฑ ูุน ุงุณูู ุดูุก ูู ุงูุฃุฑุถ ููุง ูู ุงูุณูุงุก ููู ุงูุณููุน ุงูุนููู (ูฃ ูุฑุงุช)

ุฑุถูุช ุจุงููู ุฑุจุง ูุจุงูุฅุณูุงู ุฏููุง ูุจูุญูุฏ ุตูู ุงููู ุนููู ูุณูู ูุจูุง (ูฃ ูุฑุงุช)

ุงูููู ุตู ูุณูู ูุจุงุฑู ุนูู ูุจููุง ูุญูุฏ (ูข ูุฑุงุช)

ุฃุตุจุญูุง ูุฃุตุจุญ ุงูููู ููู ูุงูุญูุฏ ูููุ ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏุ ููู ุนูู ูู ุดูุก ูุฏูุฑุ ุฑุจ ุฃุณุฃูู ุฎูุฑ ูุง ูู ูุฐุง ุงูููู ูุฎูุฑ ูุง ุจุนุฏูุ ูุฃุนูุฐ ุจู ูู ุดุฑ ูุง ูู ูุฐุง ุงูููู ูุดุฑ ูุง ุจุนุฏูุ ุฑุจ ุฃุนูุฐ ุจู ูู ุงููุณู ูุณูุก ุงููุจุฑุ ุฑุจ ุฃุนูุฐ ุจู ูู ุนุฐุงุจ ูู ุงููุงุฑ ูุนุฐุงุจ ูู ุงููุจุฑ

ุงูููู ูุง ุฃุตุจุญ ุจู ูู ูุนูุฉ ุฃู ุจุฃุญุฏ ูู ุฎููู ูููู ูุญุฏู ูุง ุดุฑูู ููุ ููู ุงูุญูุฏ ููู ุงูุดูุฑ

ุงูููู ุนุงูู ุงูุบูุจ ูุงูุดูุงุฏุฉ ูุงุทุฑ ุงูุณูุงูุงุช ูุงูุฃุฑุถ ุฑุจ ูู ุดูุก ููููููุ ุฃุดูุฏ ุฃู ูุง ุฅูู ุฅูุง ุฃูุชุ ุฃุนูุฐ ุจู ูู ุดุฑ ููุณู ููู ุดุฑ ุงูุดูุทุงู ูุดุฑููุ ูุฃู ุฃูุชุฑู ุนูู ููุณู ุณูุกุง ุฃู ุฃุฌุฑู ุฅูู ูุณูู

ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏุ ููู ุนูู ูู ุดูุก ูุฏูุฑ"""

EVENING_DHIKR = """๐ ุฃุฐูุงุฑ ุงููุณุงุก

ุฃุนูุฐ ุจูููุงุช ุงููู ุงูุชุงูุงุช ูู ุดุฑ ูุง ุฎูู (ูฃ ูุฑุงุช)

ุงูููู ุตู ูุณูู ุนูู ูุจููุง ูุญูุฏ (ูค ูุฑุงุช)

ุงูููู ุฃูุช ุฑุจู ูุง ุฅูู ุฅูุง ุฃูุชุ ุฎููุชูู ูุฃูุง ุนุจุฏูุ ูุฃูุง ุนูู ุนูุฏู ููุนุฏู ูุง ุงุณุชุทุนุชุ ุฃุนูุฐ ุจู ูู ุดุฑ ูุง ุตูุนุชุ ุฃุจูุก ูู ุจูุนูุชู ุนูู ูุฃุจูุก ุจุฐูุจู ูุงุบูุฑ ูู ูุฅูู ูุง ูุบูุฑ ุงูุฐููุจ ุฅูุง ุฃูุช

ุจุณู ุงููู ุงูุฐู ูุง ูุถุฑ ูุน ุงุณูู ุดูุก ูู ุงูุฃุฑุถ ููุง ูู ุงูุณูุงุก ููู ุงูุณููุน ุงูุนููู (ูฃ ูุฑุงุช)

ุฑุถูุช ุจุงููู ุฑุจุง ูุจุงูุฅุณูุงู ุฏููุง ูุจูุญูุฏ ุตูู ุงููู ุนููู ูุณูู ูุจูุง (ูฃ ูุฑุงุช)

ุงูููู ุตู ูุณูู ูุจุงุฑู ุนูู ูุจููุง ูุญูุฏ (ูข ูุฑุงุช)

ุฃูุณููุง ูุฃูุณู ุงูููู ููู ูุงูุญูุฏ ูููุ ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏุ ููู ุนูู ูู ุดูุก ูุฏูุฑุ ุฑุจ ุฃุณุฃูู ุฎูุฑ ูุง ูู ูุฐู ุงููููุฉ ูุฎูุฑ ูุง ุจุนุฏูุงุ ูุฃุนูุฐ ุจู ูู ุดุฑ ูุง ูู ูุฐู ุงููููุฉ ูุดุฑ ูุง ุจุนุฏูุงุ ุฑุจ ุฃุนูุฐ ุจู ูู ุงููุณู ูุณูุก ุงููุจุฑุ ุฑุจ ุฃุนูุฐ ุจู ูู ุนุฐุงุจ ูู ุงููุงุฑ ูุนุฐุงุจ ูู ุงููุจุฑ

ุงูููู ูุง ุฃูุณู ุจู ูู ูุนูุฉ ุฃู ุจุฃุญุฏ ูู ุฎููู ูููู ูุญุฏู ูุง ุดุฑูู ููุ ููู ุงูุญูุฏ ููู ุงูุดูุฑ

ุงูููู ุนุงูู ุงูุบูุจ ูุงูุดูุงุฏุฉ ูุงุทุฑ ุงูุณูุงูุงุช ูุงูุฃุฑุถ ุฑุจ ูู ุดูุก ููููููุ ุฃุดูุฏ ุฃู ูุง ุฅูู ุฅูุง ุฃูุชุ ุฃุนูุฐ ุจู ูู ุดุฑ ููุณู ููู ุดุฑ ุงูุดูุทุงู ูุดุฑููุ ูุฃู ุฃูุชุฑู ุนูู ููุณู ุณูุกุง ุฃู ุฃุฌุฑู ุฅูู ูุณูู

ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏุ ููู ุนูู ูู ุดูุก ูุฏูุฑ"""

SLEEP_DHIKR = """๐ ูุงู ูุฃูุช ูุบููุฑ ุงูุฐูุจ

ูุงู ุฑุณูู ุงููู ๏ทบ:
"ูู ูุงู ุญูู ูุฃูู ุฅูู ูุฑุงุดู:
'ูุง ุฅูู ุฅูุง ุงููู ูุญุฏู ูุง ุดุฑูู ููุ ูู ุงูููู ููู ุงูุญูุฏุ ููู ุนูู ูู ุดูุก ูุฏูุฑุ ูุง ุญูู ููุง ููุฉ ุฅูุง ุจุงูููุ ุณุจุญุงู ุงููู ูุงูุญูุฏ ููู ููุง ุฅูู ุฅูุง ุงููู ูุงููู ุฃูุจุฑ'

ุบูุฑ ุงููู ุฐููุจู ุฃู ุฎุทุงูุงู ูุฅู ูุงูุช ูุซู ุฒุจุฏ ุงูุจุญุฑ." ๐ค๐"""

# ================= ุฑุณุงุฆู ุงูุฃูุงูุฑ =================
START_RESPONSE = """๐ค *ุจูุช ุฃุฐูุงุฑ ุงูุตุจุงุญ ูุงููุณุงุก*

โ *ุชู ุชูุนูู ุงูุฅุดุนุงุฑุงุช ุงูููููุฉ*

โฐ *ููุงุนูุฏ ุงูุฅุฐูุงุฑ:*
โข ุงูุตุจุงุญ: 8:30 ุตุจุงุญุงู
โข ุงููุณุงุก: 4:00 ูุณุงุกู

๐คฒ *ูุง ุชูุณูุง ุงูุฏุนุงุก ููู ูุงู ุณุจุจุงู ูู ูุฐุง ุงูุฎูุฑ*
๐๏ธ *ุงูุตุงูุน:* @Mik_emm"""

HELP_RESPONSE = """โข /start - ุจุฏุก ุงูุจูุช ูุนุฑุถ ุงููุนูููุงุช
โข /help - ุนุฑุถ ูุฐู ุงูุฑุณุงูุฉ
โข /status - ุญุงูุฉ ุงูุจูุช

๐๏ธ ุงูุตุงูุน: @Mik_emm"""

# ================= Flask =================
app = Flask(__name__)
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

bot_instance = None
is_running = False
last_sent = {}

# ================= Bot =================
def get_bot():
    global bot_instance
    if bot_instance is None:
        bot_instance = Bot(token=TELEGRAM_TOKEN)
    return bot_instance

def send_message_simple(chat_id, text, use_markdown=False):
    try:
        bot = get_bot()

        async def send_async():
            if use_markdown:
                await bot.send_message(chat_id=chat_id, text=text, parse_mode="Markdown")
            else:
                await bot.send_message(chat_id=chat_id, text=text)

        asyncio.run_coroutine_threadsafe(send_async(), event_loop)
        return True
    except Exception as e:
        logger.error(f"โ ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุฑุณุงูุฉ: {e}")
        return False

# ================= Webhook =================
@app.route("/webhook", methods=["POST"])
def webhook():
    data = request.get_json()
    if not data or "message" not in data:
        return jsonify({"ok": True})

    msg = data["message"]
    chat_id = msg["chat"]["id"]
    chat_type = msg["chat"]["type"]
    user_id = msg["from"]["id"]
    user_name = msg["from"].get("first_name", "")
    text = msg.get("text", "")

    logger.info(f"๐ฉ {text} ูู {user_id}")

    if text.startswith("/start"):
        send_message_simple(chat_id, START_RESPONSE, True)
    elif text.startswith("/help"):
        send_message_simple(chat_id, HELP_RESPONSE, False)
    elif text.startswith("/status"):
        now = datetime.now(TIMEZONE)
        send_message_simple(
            chat_id,
            f"""๐ *ุญุงูุฉ ุงูุจูุช*

โ ุงูุจูุช: ูุนูู ๐ข
โฐ {now.strftime('%H:%M:%S')}
๐ {now.strftime('%Y-%m-%d')}

๐๏ธ ุงูุตุงูุน: @Mik_emm""",
            True
        )

    return jsonify({"ok": True})

# ================= ุชุดุบูู =================
if __name__ == "__main__":
    async def set_hook():
        await get_bot().set_webhook(WEBHOOK_URL)

    asyncio.run_coroutine_threadsafe(set_hook(), event_loop)

    port = int(os.environ.get("PORT", 10000))
    app.run(host="0.0.0.0", port=port)

